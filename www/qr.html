<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>NetPass - QR Generator</title>
	<link rel="stylesheet" href="styles.css">
	<link rel="icon" href="assets/favicon_netpass.png" type="image/png">
	<script type="application/javascript" defer src="qrcode.js"></script>
</head>
<body>
	<header>
		<div class="logo">
			<img src="assets/netpasslogo.png" alt="NetPass' logo">
		</div>
	</header>
		<nav>
		<ul>
			<li><a href="./">Go Back</a></li>
		</ul>
	</nav>
	<section>
		<h2>QR Generator</h2>
		<p>Generate various qr cods for usage with NetPass</p>
		<img id="qr-image"></img>
		<form id="qr-data">
			<select required name="type" size="1">
				<option value="dl-pass" selected>Generate an HTTP QR code to download a pass</option>
				<option value="join-event-location">Join an event location</option>
			</select>
			<div class="qr-form-values join-event-location">
				<label for="name">Name: </label><input type="text" name="name" /><br>
				<label for="uuid">Uuid </label><input type="text" name="uuid" /><br>
			</div>
			<div class="qr-form-values dl-pass">
				<label for="url">URL: </label><input type="text" name="url" /><br>
			</div>
			<input type="submit" value="Generate QR Code" />
		</form>
		<p>Powered by <a href="https://github.com/soldair/node-qrcode" target="_blank">node-qrcode</a></p>
	</section>
<script type="application/javascript">

function newBuffer(capacity) {
	return {
		cursor: 0,
		buffer: new ArrayBuffer(capacity),
	};
}

function bufferWriteRawString(buffer, string) {
	const encoded = new TextEncoder().encode(string);
	new Uint8Array(buffer.buffer).set(encoded, buffer.cursor);
	buffer.cursor += encoded.byteLength;
}

function bufferWriteInt(buffer, number) {
	new DataView(buffer.buffer).setInt32(buffer.cursor, number, true);
	buffer.cursor += 4;
}

function bufferWriteString(buffer, string) {
	const encoded = new TextEncoder().encode(string);
	bufferWriteInt(buffer, encoded.byteLength + 1);
	bufferWriteRawString(buffer, string);
	bufferWriteRawString(buffer, "\0");
}

function bufferWriteBuffer(buffer, newbuf) {
	new Uint8Array(buffer.buffer).set(newbuf, buffer.cursor);
	buffer.cursor += newbuf.byteLength;
}

function bufferFinalise(buffer) {
	return buffer.buffer.slice(0, buffer.cursor);
}

const form = document.getElementById("qr-data");

function showCorrectForm() {
	const type = form.elements["type"].value;
	for (elem of document.getElementsByClassName("qr-form-values")) {
		elem.style.display = "none";
	}
	for (elem of document.getElementsByClassName(type)) {
		elem.style.display = "";
	}
}

showCorrectForm();
form.elements["type"].addEventListener("change", showCorrectForm);

form.addEventListener("submit", (e) => {
	e.preventDefault();
	const type = form.elements["type"].value;
	const buffer = newBuffer(1000);
	bufferWriteRawString(buffer, "NPQR");
	if (type == "dl-pass") {
		const url = form.elements["url"].value;
		bufferWriteInt(buffer, 3); // method = download pass
		bufferWriteString(buffer, url);
	}
	if (type == "join-event-location") {
		const name = form.elements["name"].value;
		const uuid = form.elements["uuid"].value;
		bufferWriteInt(buffer, 2); // method = join event location
		bufferWriteString(buffer, name); // name of the event location
		bufferWriteBuffer(buffer, Uint8Array.fromHex(uuid.trim().split("-").join("")));
	}


	const bytes = bufferFinalise(buffer);
	new QRCode.toDataURL([{data: bytes, mode: "bytes"}], { errorCorrectionLevel: "L" }, (err, url) => {
		document.getElementById("qr-image").src = url;
	});

	return false;
});

</script>
</body>
</html>
